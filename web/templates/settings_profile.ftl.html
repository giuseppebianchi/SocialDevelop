<!-- SUB Banner -->
  <div class="sub-bnr user-profile-bnr">
    <div class="position-center-center">
      <div class="container">
        <h2>Profile Settings</h2>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Proin nibh augue conseqaut nibbhi ellit ipsum consectetur. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Proin nibh augue conseqaut nibbhi ellit ipsum consectetur.</p>
      </div>
    </div>
  </div>
  
  <!-- Compny Profile -->
  <div class="compny-profile"> 
    
    <!-- Profile Company Content -->
    <div class="profile-company-content" data-bg-color="fff">
      <div class="container">
          <#if updated_profile??>
            <div class="alert alert-success alert-dismissible" role="alert">
            <button type="button" class="close">Ã—</button>
            <strong>Well done!</strong> Your profile has been updated successfully. </div>
          </#if>
        <div class="row"> 
          
          <!-- SIDE BAR -->
            <div class="col-md-4"> 
              <!-- Company Information -->
              <div class="pt50">
                
              <!-- OPTIONS -->
                <div class="sidebar-information">
                  <div class="profile-usermenu">
                    <ul class="nav nav-links">
                      <li class="active"> <a> <i class="fa fa-group"></i> Profile </a> </li>
                      <li> <a href="${request.getContextPath()}/settings/account"> <i class="fa fa-plus-circle"></i> Account </a> </li>
                      <#if isAdmin??>
                      <li> <a href="${request.getContextPath()}/admin/skills"> <i class="fa fa-lock"></i> Admin Area </a> </li>
                      </#if>
                      <!--<li> <a href="#."> <i class="fa fa-cog"></i> Settings </a> </li>-->
                      <li> <a href="${request.getContextPath()}/logout"> <i class="fa fa-sign-out"></i> Sign out </a> </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          

          <!-- Tab Content -->
          <div class="col-md-8">
            <div class="network pt50">
                <h5 class="tab-title">Public Profile</h5>
                <hr class="mt10">
                <form id="form-profile" method="post" action="${request.getContextPath()}/settings/profile/profile_submit">
                <div class="row">
                    <div class="col-xs-8">
                        <h6 class="input-label">First Name</h6>
                        <input id="profile_name" type="text" name="profile_name" value="${name}" placeholder="">
                        <input id="form-data" type="hidden" name="data">
                        <h6 class="input-label">Last Name</h6>
                        <input id="profile_surname" type="text" name="profile_surname" value="${surname}" placeholder="">
                        <h6 class="input-label">Email</h6>
                        <input id="profile_email" type="email" name="profile_email" value="${mail}" placeholder=""> 
                        </div>
                    <div class="col-xs-4">
                        <div class="img-block avatar-200"></div>
                        <br>
                        <label for="#upload-picture" class="btn-block"><a class="btn btn-primary btn-block">Upload New Picture</a></label>
                    </div>
                </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <h6 class="input-label">Biography</h6>
                        <div id="profile-biography">${biography}</div>
                        </div>
                    </div>
                
                <br>
                <h5 class="tab-title">Developer</h5>
                <hr class="mt10">
                <div class="row">
                    <div class="col-sm-12">
                 <p class="tab-subtitle">Your job or a short description about your work.</p>
                <!--<div class="checkbox">
                  <input id="checkbox1" class="styled" type="checkbox">
                  <label for="checkbox1"> Developer Account</label>
                </div>-->
                 <h6 class="input-label">Job</h6>
                     <input id="profile_headline" type="text" name="headline" value="${headline}" placeholder="Job or Headline">
                   <h6 class="input-label">Resume</h6>
                         <div id="profile-resume">${resume?no_esc}</div>
                 </div>
                </div>
                <h6 class="input-label">Skills</h6>
                <p>Your professional skills.</p>
                    <div id="skills-list">
                        <#list skillsList as key,value>
                        <div class="row" id="existing-skill-${key.key}" style="margin: 15px 0 0">
                            <div class="col-xs-6">
                                <div class="uou-progressbar-single">
                            <h6>${key.name}</h6>
                            <span class="main-bar"> <span class="inner-bar" style="width: ${value}0%"></span> <a class="progress-percent">${value}</a> </span> 
                            </div>
                            </div>
                                <div class="col-xs-1"><a href="#" data-id="${task.key}" data-key=${key.key} data-existing="true" class="remove-skill-button text-danger a-block mt10"><i class="fa fa-times"></i></a></div>
                        </div>
                        </#list>
                    </div>
                    <div class="row">
                  <div class="col-sm-8">
                      
                      <select name="select_skill" id="select-skill" class="js-example-placeholder-single" style="width: 100%; display: inline;">
                          <option></option>
                          <#list skills as skill>
                            <option class="option-skills" value="${skill.key}" data-name="${skill.name}">${skill.name}</option>
                          </#list>
                      </select>
                  </div>
                  <div class="col-sm-2">
                      <select id="level-skill">
                          <option>Level</option>
                          <option value="1">1</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                          <option value="4">4</option>
                          <option value="5">5</option>
                          <option value="6">6</option>
                          <option value="7">7</option>
                          <option value="8">8</option>
                          <option value="9">9</option>
                          <option value="10">10</option>
                      </select>
                  </div>
                  <div class="col-sm-2">
                      <a class="btn btn-primary btn-block" id="add-new-skill">Add Skill</a>
                  </div>
                      
              </div>
                <br>
                <input type="submit" class="btn btn-success" value="Update Profile">
                </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="${request.getContextPath()}/theme/plugins/summernote/summernote.min.js"></script> 
  <script>
  $(document).ready(function(){
      var ctx = "${request.getContextPath()}";
      
        $("#select-job").select2({
            placeholder: "Select a Job",
            allowClear: true
          });
         var select_skill = $("#select-skill");
         select_skill.select2({
            placeholder: "Select a skill",
            allowClear: true
          });
        $('#profile-biography').summernote({
            minHeight: 300
        });
        $('#profile-resume').summernote({
            minHeight: 300
        });
        
        //skills
        var id_skill = 0;
        var existing_skills = {
            <#list skillsList as key,value>
               "${key.key}" : "${key.name}",
            </#list>
        };
        var skills = {};
        var options = {};
        var removed_skills = [];
        var skills_list = $("#skills-list");
        var level_skill = $("#level-skill");
        var skillTemplate;
        $.get(ctx + "/templates/mustache/skillTemplate.html", function(t){
                skillTemplate = t;
        });
        $('#add-new-skill').click(function(e){
            e.preventDefault();
            var key = select_skill.val();
            options[key] = select_skill.find(":selected")[0];
            if(existing_skills[key]){
                $(options[key]).attr("disabled", "disabled");
                select_skill.select2();
                select_skill.select2("val", "");
                level_skill.get(0).selectedIndex = 0;
                return false;
            }
            
            skills[id_skill] = {
                "name": $(options[key]).data("name"),
                "key": key,
                "level": level_skill.val(),
                "id": id_skill
            }
            skills_list.append(Mustache.render(skillTemplate, skills[id_skill]))
            id_skill++;
            $(options[key]).attr("disabled", "disabled");
            select_skill.select2();
            select_skill.select2("val", "");
            level_skill.get(0).selectedIndex = 0;
        })
        $("body").on("click", '.remove-skill-button', function(e){
            e.preventDefault();
            var id = $(this).data("id");
            var key = $(this).data("key");
            var existing = $(this).data("existing");
            if(existing){
                delete existing_skills[key];
                removed_skills.push(key)
                $("#existing-skill-" + key).remove();
            }else{
                delete skills[id];
                $("#skill-" + id).remove();
            }
            
            $(options[key]).removeAttr("disabled");
            select_skill.select2();
            delete options[key];
            
        });
        
        $("#form-profile").submit(function(e){
        var validation = true;
        $('.error-text').empty();
        var data = {
                "profile_id": ${auth_user},
                "profile_email": "${mail}",
                "profile_username": "${username}",
                "profile_name": $('#profile_name').val(),
                "profile_surname": $('#profile_surname').val(),
                "profile_headline": $('#profile_headline').val(),
                "profile_biography": $("#profile-biography").summernote('code'),
                "profile_resume": $("#profile-resume").summernote('code'),
                "skills": skills  ,
                "removed_skills": removed_skills
            }
            
        //CONTROLLI
        if (data.profile_name === null || data.profile_name === "") {
            validation = false;
            $('#profile_name').before('<span class="error-text">Profile name is missing.</span>');
        }

        if (data.profile_surname === null || data.profile_surname === "") {
            validation = false;
            $('#profile_surname').before('<span class="error-text">Project surname is missing.</span>');
        }

        if (data.profile_headline === null || data.profile_headline === "") {
            validation = false;
            $('#profile_headline').before('<span class="error-text">Profile headline is missing.</span>');
        }

        if (data.profile_biography === null || data.profile_biography === "") {
            validation = false;
            $('#project_name').before('<span class="error-text">Profile biography is missing.</span>');
        }

        if (data.profile_resume === null || data.profile_resume === "") {
            validation = false;
            $('#project_name').before('<span class="error-text">Profile resume is missing.</span>');
        }
        
        if(validation){
            $("#form-data").val(JSON.stringify(data))
            return true;
        }else{
            return false;
        }
            
        })
        
    })
  </script>